<!--
  Project: FocusFlow
  Description: A productivity web app combining Task Manager, Kanban Board, and the Pomodoro Technique
               to organize tasks, visualize progress, and stay focused.
  Author: Ahmed Hafez
  Date: 2025-09-01
  File: index.html
-->

<!doctype html>
<html lang="ar" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>( FocusFlow ðŸŒ€ ) Task Manager + Kanbana + Pomodoro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#f3f4f6;--card:#ffffff;--muted:#8b8c8d;--card-dark:#f7f7f9;--card-light:#ffffff}
    body{background:var(--bg);font-family:"Segoe UI",Tahoma,Arial}
    .gray-card{background:var(--card);border:0;border-radius:12px}
    .kanban-col{min-height:240px;padding:12px;border-radius:10px;background:var(--card-dark);color:#fff}
    .task-card{background:var(--card-light);border-radius:10px;border:1px solid #e9e9ea;box-shadow:0 1px 2px rgba(0,0,0,0.03);color:#111}
    .kanban-col h6{color:#8b8c8d}
    .badge-ghost{background:transparent;color:var(--muted);border:1px dashed #d0d0d0}
    .no-select{user-select:none}
    .small-muted{font-size:0.85rem;color:var(--muted)}
    .btn-ghost{background:transparent;border:1px solid #d0d0d0;color:#333}
    .controls .btn{min-width:44px}
    .file-input{display:none}
    #sessionsChartWrap{height:220px}
    #sessionsTable td, #sessionsTable th{background:#fff}
    #allSessionsModal .modal-body .table-responsive{max-height:320px;overflow-y:auto}
    .howto{background:#fff;border-radius:8px;padding:12px;margin-top:10px;color:#333}
  </style>
</head>
<body>
  <div class="container my-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4 class="mb-0">( FocusFlow ðŸŒ€ ) Task Manager + Kanbana + Pomodoro</h4>
      <div class="d-flex gap-2">
        <input id="importFile" class="file-input" type="file" accept="application/json">
        <button id="btnImport" class="btn btn-outline-secondary">import</button>
        <button id="btnExport" class="btn btn-outline-secondary">export</button>
        <div class="form-check form-switch align-self-center">
          <input class="form-check-input" type="checkbox" id="notifyToggle">
          <label class="form-check-label small-muted" for="notifyToggle">Activate notifications</label>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-md-8">
        <div class="card gray-card p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <button id="addTaskBtn" class="btn btn-primary">Add a new task</button>
            </div>
            <div class="small-muted">Use drag and drop to move tasks between columns.</div>
          </div>

          <div class="row g-3">
            <div class="col-md-4">
              <div class="kanban-col p-2" data-col="todo">
                <h6 class="text-center small-muted">Didn't start</h6>
                <div class="task-list" id="col-todo"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="kanban-col p-2" data-col="doing">
                <h6 class="text-center small-muted">in progress</h6>
                <div class="task-list" id="col-doing"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="kanban-col p-2" data-col="done">
                <h6 class="text-center small-muted">finish</h6>
                <div class="task-list" id="col-done"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card gray-card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Sessions report</h6>
            <div>
              <button id="showAllBtn" class="btn btn-sm btn-outline-secondary">View all</button>
            </div>
          </div>

          <div class="table-responsive mb-3">
            <table class="table table-sm" id="sessionsTable">
              <thead>
                <tr><th>Session type</th><th>Duration (minutes)</th><th>date</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div id="sessionsChartWrap">
            <canvas id="sessionsChart"></canvas>
          </div>

        </div>


        
        <div class="card gray-card p-3 mt-3">
          <h6 class="mb-2">Task report</h6>
          <div class="table-responsive mb-3">
            <table class="table table-sm" id="tasksReportTable">
              <thead><tr><th>task</th><th>Number of sessions</th><th>Total minutes</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <!-- <div style="height:220px">
            <canvas id="tasksReportChart"></canvas>
          </div> -->
        </div>
        
        


      </div>

      <div class="col-md-4">
        <div class="card gray-card p-3 mb-3">
          <h6>The promodoro</h6>
          <div class="mb-2 small-muted">Focus time and rest time are adjustable.</div>
          <div class="mb-2">
            <label class="form-label small-muted">Concentration (minutes)</label>
            <input id="focusInput" type="number" min="1" max="180" class="form-control" value="25">
          </div>
          <div class="mb-2">
            <label class="form-label small-muted">Rest (minutes)</label>
            <input id="breakInput" type="number" min="1" max="60" class="form-control" value="5">
          </div>

          <div class="text-center my-3">
            <div id="pomodoroMode" class="small-muted">Get ready</div>
            <div id="timerDisplay" class="fs-2 fw-bold">00:00</div>
            <div class="small-muted mb-2" id="currentTaskLabel">No task selected</div>
            <div class="d-flex justify-content-center gap-2 controls">
              <button id="pauseBtn" class="btn btn-ghost" disabled>Stop</button>
              <button id="resumeBtn" class="btn btn-ghost" disabled>resumption</button>
              <button id="resetBtn" class="btn btn-ghost" disabled>Reset</button>
            </div>
          </div>

          <hr>
          <h6>Period statistics</h6>
          <div class="table-responsive mb-2">
            <table class="table table-sm" id="statsTable">
              <thead><tr><th>Period</th><th>Sessions</th><th>Total (minutes)</th></tr></thead>
              <tbody>
                <tr><td>today</td><td id="s-today">0</td><td id="m-today">0</td></tr>
                <tr><td>yesterday</td><td id="s-yesterday">0</td><td id="m-yesterday">0</td></tr>
                <tr><td>Current month</td><td id="s-month">0</td><td id="m-month">0</td></tr>
                <tr><td>previous month</td><td id="s-prevmonth">0</td><td id="m-prevmonth">0</td></tr>
                <tr><td>Total</td><td id="s-total">0</td><td id="m-total">0</td></tr>
              </tbody>
            </table>
          </div>
          <canvas id="statsChart" height="120"></canvas>
        </div>
        <div class="howto">
          <strong>Explanation of use:</strong>
          <p>1. Add a new task from the template. It will automatically appear in the Kanban board in the <em>Not Started</em> column. You can drag it between the columns (Not Started â€“ In Progress â€“ Finished).</p>
          <p>2. To start a Pomodoro session, select the task from the Kanban and click the <strong>Start Focus</strong> button. The time and duration will be automatically saved when the session ends.</p>
          <p>3. If you close the page or refresh, the timer will continue from the last point it stopped (the state is saved locally in the browser).</p>
          <p>4. You can use the <strong>Import</strong> or <strong>Export</strong> button to save all tasks and sessions to a JSON file or restore them later.</p>
          <p>5. The <strong>Activate Notifications</strong> button allows you to be alerted when your focus or rest time is over, even if you are in another tab.</p>
          <p>6. The <strong>View All</strong> button displays all previous sessions in a separate window with a scrollable table.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add/edit a task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Task name</label>
            <input id="taskName" class="form-control">
          </div>
          <div class="mb-2">
            <label class="form-label">Description</label>
            <textarea id="taskDesc" class="form-control" rows="3"></textarea>
          </div>
          <input type="hidden" id="taskId">
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">cancel</button>
          <button id="saveTaskBtn" class="btn btn-primary">save</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="allSessionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">All Pomodoro sessions</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-sm" id="allSessionsTable">
              <thead><tr><th>Session type</th><th>Duration (minutes)</th><th>date</th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><td><strong>total</strong></td><td id="allSessionsTotal">0</td><td></td></tr></tfoot>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>

<script>
// ===== Data model & persistence =====
const STORAGE_KEY = 'kanban_pomodoro_v1';
let state = {
  tasks: [], // {id,name,desc,col}
  sessions: [], // {taskId,type,durationMinutes,start,end}
  settings: {focusMin:25, breakMin:5, notify:false},
  timer: null // persisted timer state {running,mode,endTs,paused,taskId, remainingMs}
};

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) state = JSON.parse(raw);
  }catch(e){console.error(e)}
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// ===== utilities =====
function uid(){return 't'+Date.now()+Math.floor(Math.random()*999)}
function fmtTime(ms){
  const s = Math.ceil(ms/1000);
  const m = Math.floor(s/60); const sec = s%60;
  return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
}
function toDateInput(d){return new Date(d).toLocaleString();}
function toDateKey(d){ const dt = new Date(d); return dt.getFullYear()+'-'+(dt.getMonth()+1)+'-'+dt.getDate(); }

// ===== DOM refs =====
const colTodo = document.getElementById('col-todo');
const colDoing = document.getElementById('col-doing');
const colDone = document.getElementById('col-done');
const addTaskBtn = document.getElementById('addTaskBtn');
const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
const allSessionsModal = new bootstrap.Modal(document.getElementById('allSessionsModal'));
const taskName = document.getElementById('taskName');
const taskDesc = document.getElementById('taskDesc');
const taskIdInput = document.getElementById('taskId');
const saveTaskBtn = document.getElementById('saveTaskBtn');
const focusInput = document.getElementById('focusInput');
const breakInput = document.getElementById('breakInput');
const timerDisplay = document.getElementById('timerDisplay');
const pomodoroMode = document.getElementById('pomodoroMode');
const currentTaskLabel = document.getElementById('currentTaskLabel');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
const resetBtn = document.getElementById('resetBtn');
const notifyToggle = document.getElementById('notifyToggle');
const btnExport = document.getElementById('btnExport');
const btnImport = document.getElementById('btnImport');
const importFile = document.getElementById('importFile');
const showAllBtn = document.getElementById('showAllBtn');

// reports & charts refs
const sessionsTable = document.querySelector('#sessionsTable tbody');
const allSessionsTable = document.querySelector('#allSessionsTable tbody');
const allSessionsTotal = document.getElementById('allSessionsTotal');
const sessionsChartCtx = document.getElementById('sessionsChart');
const statsChartCtx = document.getElementById('statsChart');
let sessionsChart, statsChart;

// ===== Drag & Drop =====
function makeDraggable(el){
  el.setAttribute('draggable','true');
  el.addEventListener('dragstart', e=>{
    e.dataTransfer.setData('text/plain', el.dataset.id);
    e.dataTransfer.effectAllowed = 'move';
  });
}
[...document.querySelectorAll('.kanban-col')].forEach(col=>{
  col.addEventListener('dragover', e=>{e.preventDefault(); e.dataTransfer.dropEffect='move';});
  col.addEventListener('drop', e=>{
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    const task = state.tasks.find(t=>t.id===id);
    if(task){
      const newCol = col.dataset.col;
      task.col = newCol;
      saveState(); render();
    }
  });
});

// ===== CRUD tasks =====
addTaskBtn.addEventListener('click', ()=>{
  taskIdInput.value = '';
  taskName.value = '';
  taskDesc.value = '';
  taskModal.show();
});
saveTaskBtn.addEventListener('click', ()=>{
  const id = taskIdInput.value || uid();
  const name = taskName.value.trim();
  const desc = taskDesc.value.trim();
  if(!name){alert('Type the name of the task');return}
  const existing = state.tasks.find(t=>t.id===id);
  if(existing){existing.name = name; existing.desc = desc;} else {
    state.tasks.push({id,name,desc,col:'todo'});
  }
  saveState(); taskModal.hide(); render();
});

function editTask(id){
  const t = state.tasks.find(x=>x.id===id); if(!t) return;
  taskIdInput.value = t.id; taskName.value = t.name; taskDesc.value = t.desc; taskModal.show();
}
function deleteTask(id){
  if(!confirm('Delete task?')) return;
  state.tasks = state.tasks.filter(t=>t.id!==id);
  // remove related sessions
  state.sessions = state.sessions.filter(s=>s.taskId!==id);
  saveState(); render();
}

// ===== Pomodoro engine =====
let timer = {running:false, mode:null, // 'focus' or 'break'
  remainingMs:0, endTs:null, paused:false, taskId:null, interval:null
};

function persistTimerToState(){
  // ensure we persist running state even if startInterval() hasn't set timer.running yet
  if(timer.endTs && !timer.paused){
    state.timer = {running:true, mode:timer.mode, endTs: timer.endTs, paused:false, taskId:timer.taskId};
  } else if(timer.paused){
    // when paused, store remainingMs
    state.timer = {running:false, mode:timer.mode, endTs:null, paused:true, taskId:timer.taskId, remainingMs: timer.remainingMs};
  } else {
    state.timer = null;
  }
  saveState();
};
//   } else if(timer.paused){
//     // when paused, store remainingMs
//     state.timer = {running:false, mode:timer.mode, endTs:null, paused:true, taskId:timer.taskId, remainingMs: timer.remainingMs};
//   } else {
//     state.timer = null;
//   }
//   saveState();
// }

function startPomodoroForTask(taskId){
  const t = state.tasks.find(x=>x.id===taskId); if(!t) return;
  if(t.col==='todo') t.col='doing';
  if(t.col==='done') t.col='doing';
  saveState(); render();
  timer.mode='focus'; timer.taskId=taskId; timer.paused=false;
  timer.remainingMs = (Number(focusInput.value)||state.settings.focusMin)*60*1000;
  timer.endTs = Date.now() + timer.remainingMs;
  persistTimerToState();
  startInterval(); updatePomodoroUI();
}

function startInterval(){
  if(timer.interval) clearInterval(timer.interval);
  timer.running=true;
  timer.interval = setInterval(()=>{
    if(timer.paused) return;
    const rem = timer.endTs - Date.now();
    timer.remainingMs = Math.max(0, rem);
    updatePomodoroUI();
    if(timer.remainingMs<=0){
      clearInterval(timer.interval);
      timer.interval=null; timer.running=false;
      onSessionEnd();
    }
  },250);
}

function pauseTimer(){ if(!timer.running) return; timer.paused=true; timer.remainingMs = Math.max(0, timer.endTs - Date.now()); timer.running=false; if(timer.interval) clearInterval(timer.interval); pauseBtn.disabled=true; resumeBtn.disabled=false; persistTimerToState(); updatePomodoroUI(); }
function resumeTimer(){ if(!timer.paused) return; timer.paused=false; timer.endTs = Date.now() + (timer.remainingMs || ((Number(focusInput.value)||state.settings.focusMin)*60*1000)); startInterval(); pauseBtn.disabled=false; resumeBtn.disabled=true; persistTimerToState(); updatePomodoroUI(); }
function resetTimer(){ if(timer.interval) clearInterval(timer.interval); timer={running:false,mode:null,remainingMs:0,endTs:null,paused:false,taskId:null,interval:null}; persistTimerToState(); updatePomodoroUI(); }

function onSessionEnd(){
  const actualMinutes = Math.round(((timer.mode==='focus' ? (Number(focusInput.value)||state.settings.focusMin) : (Number(breakInput.value)||state.settings.breakMin))));
  state.sessions.push({taskId:timer.taskId,type:timer.mode,durationMinutes:actualMinutes,start:new Date(Date.now()-actualMinutes*60000).toISOString(),end:new Date().toISOString()});
  saveState();
  // notify
  if(state.settings.notify) showNotification(timer.mode==='focus' ? 'Focus session ended' : 'Respite session ended');
  if(timer.mode==='focus'){
    // start break
    timer.mode='break'; timer.paused=false; timer.remainingMs = (Number(breakInput.value)||state.settings.breakMin)*60*1000; timer.endTs = Date.now()+timer.remainingMs; persistTimerToState(); startInterval(); updatePomodoroUI();
  } else {
    // finished all
    resetTimer();
    updatePomodoroUI();
  }
}

function showNotification(text){ if(Notification.permission==='granted') new Notification(text); }

function updatePomodoroUI(){
  if(timer.running){
    pauseBtn.disabled = timer.paused; resumeBtn.disabled = !timer.paused; resetBtn.disabled = false;
    pomodoroMode.textContent = timer.mode==='focus' ? 'focused' : 'resting';
    timerDisplay.textContent = fmtTime(timer.remainingMs);
    const t = state.tasks.find(x=>x.id===timer.taskId);
    currentTaskLabel.textContent = t ? (t.name): 'Unknown task';
  } else if(timer.paused){
    pauseBtn.disabled = true; resumeBtn.disabled = false; resetBtn.disabled = false;
    pomodoroMode.textContent = timer.mode==='focus' ? 'off - focus' : 'off - rest';
    timerDisplay.textContent = fmtTime(timer.remainingMs || 0);
    const t = state.tasks.find(x=>x.id===timer.taskId);
    currentTaskLabel.textContent = t ? (t.name) : 'Unknown mission';
  } else {
    pauseBtn.disabled = true; resumeBtn.disabled = true; resetBtn.disabled = true;
    pomodoroMode.textContent = 'Stopped'; timerDisplay.textContent='00:00'; currentTaskLabel.textContent='No task selected';
  }
}

pauseBtn.addEventListener('click', ()=>{ pauseTimer(); });
resumeBtn.addEventListener('click', ()=>{ resumeTimer(); });
resetBtn.addEventListener('click', ()=>{ if(confirm('Reset?')) resetTimer(); });

function startFocusFromCard(taskId){ startPomodoroForTask(taskId); }

// ===== Rendering =====
function renderTaskCard(t){
  const div = document.createElement('div');
  div.className='p-2 mb-2 task-card';
  div.dataset.id = t.id;

// Calculate the total sessions and minutes for the task
  const taskSessions = state.sessions.filter(s=>s.taskId===t.id && s.type==='focus');
  const totalSessions = taskSessions.length;
  const totalMinutes = taskSessions.reduce((sum,s)=> sum+(Number(s.durationMinutes)||0),0);

  div.innerHTML = `
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <div class="fw-bold">${escapeHtml(t.name)}</div>
        <div class="small-muted">${escapeHtml(t.desc||'')}</div>
        <div class="small-muted">Sessions: ${totalSessions}</div>
<div class="small-muted">Minutes: ${totalMinutes}</div>
      </div>
      <div class="ms-2 text-end">
        <div class="btn-group-vertical">
          <button style="font-size: 12px;padding: 5px;" class="btn btn-sm btn-outline-primary start-btn">Focus</button>
          <button style="font-size: 12px;padding: 5px;" class="btn btn-sm btn-outline-secondary edit-btn">Edit</button>
          <button style="font-size: 12px;padding: 5px;" class="btn btn-sm btn-outline-danger del-btn">Delete</button>
        </div>
      </div>
    </div>
  `;
  div.querySelector('.start-btn').addEventListener('click', ()=> startFocusFromCard(t.id));
  div.querySelector('.edit-btn').addEventListener('click', ()=> editTask(t.id));
  div.querySelector('.del-btn').addEventListener('click', ()=> deleteTask(t.id));
  makeDraggable(div);
  return div;
}

function render(){
  focusInput.value = state.settings.focusMin || focusInput.value;
  breakInput.value = state.settings.breakMin || breakInput.value;
  notifyToggle.checked = !!state.settings.notify;
  [colTodo,colDoing,colDone].forEach(c=> c.innerHTML='');
  state.tasks.forEach(t=>{
    const node = renderTaskCard(t);
    if(t.col==='todo') colTodo.appendChild(node);
    else if(t.col==='doing') colDoing.appendChild(node);
    else colDone.appendChild(node);
  });
  renderReports();
}

function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// ===== Reports & Stats =====
function renderReports(){
  sessionsTable.innerHTML='';
  const last10 = state.sessions.slice().reverse().slice(0,10);
  let totalDisplayed = 0;
  last10.forEach(s=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${s.type==='focus'? 'Focus' : 'Rest'}</td><td>${s.durationMinutes}</td><td>${toDateInput(s.end)}</td>`; sessionsTable.appendChild(tr); totalDisplayed += Number(s.durationMinutes)||0; });
  if(last10.length){ const trTotal = document.createElement('tr'); trTotal.innerHTML = `<td><strong>Total (Last 10)</strong></td><td><strong>${totalDisplayed}</strong></td><td></td>`; sessionsTable.appendChild(trTotal); }
  allSessionsTable.innerHTML=''; let totalAll = 0; state.sessions.slice().reverse().forEach(s=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${s.type==='focus' ? 'focas' : 'rest'}</td><td>${s.durationMinutes}</td><td>${toDateInput(s.end)}</td>`; allSessionsTable.appendChild(tr); totalAll += Number(s.durationMinutes)||0; }); allSessionsTotal.textContent = totalAll;
  const daily = {}; state.sessions.forEach(s=>{ const k = toDateKey(s.end); if(!daily[k]) daily[k] = {date: new Date(s.end), focus:0, break:0}; if(s.type==='focus') daily[k].focus += Number(s.durationMinutes)||0; else daily[k].break += Number(s.durationMinutes)||0; }); const days = Object.values(daily).sort((a,b)=> a.date - b.date); const labels = days.map(d=> d.date.toLocaleDateString()); const focusData = days.map(d=> d.focus); const breakData = days.map(d=> d.break);
  if(sessionsChart) sessionsChart.destroy();
  sessionsChart = new Chart(sessionsChartCtx,{ type: 'line', data: { labels: labels, datasets: [ {label: 'focas', data: focusData, borderColor:'#0d6efd', backgroundColor:'rgba(13,110,253,0.08)', tension:0.3, fill:true}, {label: 'rest', data: breakData, borderColor:'#dc3545', backgroundColor:'rgba(220,53,69,0.08)', tension:0.3, fill:true} ] }, options: { responsive:true, maintainAspectRatio:false, scales: { x: { display:true }, y: { beginAtZero:true } }, plugins: { legend: { display:true, position:'top' } } } });
  computeAndRenderStats();


// === Task Report ===
    const tasksReportTable = document.querySelector('#tasksReportTable tbody');
  const tasksReportChartCtx = document.getElementById('tasksReportChart');
  tasksReportTable.innerHTML='';
  const labelsTasks = [];
  const dataMinutes = [];
  state.tasks.forEach(t=>{
    const taskSessions = state.sessions.filter(s=>s.taskId===t.id && s.type==='focus');
    const totalSessions = taskSessions.length;
    const totalMinutes = taskSessions.reduce((sum,s)=> sum+(Number(s.durationMinutes)||0),0);
    if(totalSessions>0){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${escapeHtml(t.name)}</td><td>${totalSessions}</td><td>${totalMinutes}</td>`;
      tasksReportTable.appendChild(tr);
      labelsTasks.push(t.name);
      dataMinutes.push(totalMinutes);
    }
  });
  // if(window.tasksReportChart) window.tasksReportChart.destroy();
  // window.tasksReportChart = new Chart(tasksReportChartCtx,{
  //   type:'bar',
  //   data:{labels:labelsTasks,datasets:[{label:'Total minutes',data:dataMinutes}]},
  //   options:{responsive:true,maintainAspectRatio:false}
  // });

}

function computeAndRenderStats(){
  const now = new Date();
  const startOfToday = new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const startOfYesterday = new Date(startOfToday); startOfYesterday.setDate(startOfToday.getDate()-1);
  const startOfMonth = new Date(now.getFullYear(),now.getMonth(),1);
  const startOfPrevMonth = new Date(now.getFullYear(),now.getMonth()-1,1);
  const endOfPrevMonth = new Date(startOfMonth); endOfPrevMonth.setMilliseconds(-1);
  const stats = {today:{s:0,m:0}, yesterday:{s:0,m:0}, month:{s:0,m:0}, prevmonth:{s:0,m:0}, total:{s:0,m:0}};
  state.sessions.forEach(s=>{ const d = new Date(s.end); const minutes = Number(s.durationMinutes)||0; stats.total.s++; stats.total.m+=minutes; if(d>=startOfToday) {stats.today.s++; stats.today.m+=minutes} if(d>=startOfYesterday && d<startOfToday){stats.yesterday.s++; stats.yesterday.m+=minutes} if(d>=startOfMonth) {stats.month.s++; stats.month.m+=minutes} if(d>=startOfPrevMonth && d<=endOfPrevMonth){stats.prevmonth.s++; stats.prevmonth.m+=minutes} });
  document.getElementById('s-today').textContent = stats.today.s; document.getElementById('m-today').textContent = stats.today.m;
  document.getElementById('s-yesterday').textContent = stats.yesterday.s; document.getElementById('m-yesterday').textContent = stats.yesterday.m;
  document.getElementById('s-month').textContent = stats.month.s; document.getElementById('m-month').textContent = stats.month.m;
  document.getElementById('s-prevmonth').textContent = stats.prevmonth.s; document.getElementById('m-prevmonth').textContent = stats.prevmonth.m;
  document.getElementById('s-total').textContent = stats.total.s; document.getElementById('m-total').textContent = stats.total.m;
  const labels = ['Today','Yesterday','Month','Previous Month','Total']; const values = [stats.today.m, stats.yesterday.m, stats.month.m, stats.prevmonth.m, stats.total.m]; if(statsChart) statsChart.destroy(); statsChart = new Chart(statsChartCtx,{type:'bar',data:{labels, datasets:[{label:'minutes',data:values}]},options:{indexAxis:'y',plugins:{legend:{display:false}}}});
}

// ===== Import / Export =====
btnExport.addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify(state, null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='kanban_pomodoro_export.json'; a.click(); URL.revokeObjectURL(url); });
btnImport.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', e=>{ const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ev=>{ try{ const imported = JSON.parse(ev.target.result); if(confirm('Replace all data with the imported file?')){ state = imported; saveState(); render(); } }catch(err){alert('Invalid file')} }; reader.readAsText(f); });

// show all button
showAllBtn.addEventListener('click', ()=> allSessionsModal.show());

// ===== Notifications toggle =====
notifyToggle.addEventListener('change', async ()=>{ if(notifyToggle.checked){ if(Notification.permission!=='granted'){ const perm = await Notification.requestPermission(); if(perm!=='granted'){ notifyToggle.checked=false; state.settings.notify=false; saveState(); return; } } state.settings.notify = true; saveState(); } else { state.settings.notify = false; saveState(); } });

// ===== Settings sync =====
[focusInput, breakInput].forEach(inp=> inp.addEventListener('change', ()=>{ state.settings.focusMin = Number(focusInput.value)||state.settings.focusMin; state.settings.breakMin = Number(breakInput.value)||state.settings.breakMin; saveState(); }));

// ===== restore & init =====
loadState(); state.settings = state.settings || {focusMin:25,breakMin:5,notify:false}; if(!state.tasks) state.tasks=[]; if(!state.sessions) state.sessions=[];
// restore timer
if(state.timer){
  // if running and not paused -> reconstruct endTs
  if(state.timer.running && !state.timer.paused && state.timer.endTs){
    timer.mode = state.timer.mode; timer.taskId = state.timer.taskId; timer.paused = false; timer.endTs = Number(state.timer.endTs);
    timer.remainingMs = Math.max(0, timer.endTs - Date.now());
    if(timer.remainingMs>0){ startInterval(); }
    else { /* finished while away */ onSessionEnd(); }
  } else if(state.timer.paused){
    // paused state: restore remainingMs and show paused UI
    timer.mode = state.timer.mode; timer.taskId = state.timer.taskId; timer.paused = true; timer.remainingMs = Number(state.timer.remainingMs) || 0; timer.running=false; updatePomodoroUI();
  }
}

render(); updatePomodoroUI();
// prevent accidental text selection during drag
window.addEventListener('dragstart', e=> document.body.classList.add('no-select'));
window.addEventListener('dragend', e=> document.body.classList.remove('no-select'));
</script>
</body>
</html>
